---
title: "Bycatch Paper"
author: "Natasha Besseling"
date: "2023-06-06"
output: html_document
editor_options: 
  chunk_output_type: inline
---

load packages
```{r message=FALSE, warning=FALSE}
library(janitor)
library(fuzzySim)
library(ggthemes)
library(dendextend)
library(vegan)
library(tidyverse)
library(lubridate)
library(maptools)
library(maps)
library(mapdata)
library(wesanderson)
library(RColorBrewer)
library(sp)
library(gridExtra)
library(ggsn)  # north2() scalebar()
library(rworldmap) 
library(ggrepel)
library(plotrix)
library(ggdendro)
```

load functions
```{r echo=FALSE}
## Normalise data
normalise <- function(dat, values, id, join) {
  
  test <- dat %>%
    group_by({{id}}) %>%
    summarise(total = sum({{values}}))
  
  test1 <-  dat %>%
    left_join(test, by = {{join}})
  
  test2 <- test1 %>%
    mutate(norm = {{values}} /total)%>%
    select(-total)
}
## pairwise tests for permanova
pairwise.adonis <- function(x,factors, sim.function = 'vegdist', sim.method = 'bray', p.adjust.m ='bonferroni')
{
  library(vegan)
  
  co = combn(unique(as.character(factors)),2)
  pairs = c()
  F.Model =c()
  R2 = c()
  p.value = c()
  
  
  for(elem in 1:ncol(co)){
    if(sim.function == 'daisy'){
      library(cluster); x1 = daisy(x[factors %in% c(co[1,elem],co[2,elem]),],metric=sim.method)
    } else{x1 = vegdist(x[factors %in% c(co[1,elem],co[2,elem]),],method=sim.method)}
    
    ad = adonis(x1 ~ factors[factors %in% c(co[1,elem],co[2,elem])] );
    pairs = c(pairs,paste(co[1,elem],'vs',co[2,elem]));
    F.Model =c(F.Model,ad$aov.tab[1,4]);
    R2 = c(R2,ad$aov.tab[1,5]);
    p.value = c(p.value,ad$aov.tab[1,6])
  }
  p.adjusted = p.adjust(p.value,method=p.adjust.m)
  sig = c(rep('',length(p.adjusted)))
  sig[p.adjusted <= 0.05] <-'.'
  sig[p.adjusted <= 0.01] <-'*'
  sig[p.adjusted <= 0.001] <-'**'
  sig[p.adjusted <= 0.0001] <-'***'
  
  pairw.res = data.frame(pairs,F.Model,R2,p.value,p.adjusted,sig)
  print("Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
  return(pairw.res)
  
} 

```


load the data
```{r}
#connect to the sql database
con <- dbConnect(RPostgres::Postgres(),
                 dbname = "masters_paper",
                 port = 5432,
                 user = "postgres",
                 password = "A.inodorus")

drags <- dbReadTable(con, "drags" )
landings <- dbReadTable(con, "landings" )
drag_catches <- dbReadTable(con, "drag_catches")
landings_catches <- dbReadTable(con, "landings_catches" )


#close connection to the database
dbDisconnect(con)
```


calculate the bycatch composition by weight

```{r echo=FALSE, message=FALSE, warning=FALSE}
# total number of species

test <- landings_catches %>%
  distinct(species_code)

#49

##total catch composition

test <- landings_catches%>%
  group_by(species_code)%>%
  summarise(mass = sum(nominal_mass, na.rm = T))%>%
  mutate(proportion = mass/sum(mass))

#hake = 57.4
#sole = 4.2


## Top species

species <- landings_catches %>%
  mutate(nominal_mass= nominal_mass/1000)%>%
  group_by(species_code, docking_date_yy)%>%
  summarise(nominal_mass = sum(nominal_mass, na.rm = T))%>%
  pivot_wider(names_from = docking_date_yy, values_from = nominal_mass)%>%
  mutate_all(~replace_na(.,0))%>%
  pivot_longer(cols = 2:31, names_to = "docking_date_yy", values_to = "nominal_mass")%>%
  group_by(species_code)%>%
  summarise(nominal_mass=sum(nominal_mass)/30)


species <- species[order(-species$nominal_mass),]

species <- species %>%
  mutate(cumsum = round(cumsum(nominal_mass))) %>%
  mutate(Percent_of_total = round(cumsum/sum(nominal_mass)*100, digits= 2))%>%
  mutate(percentage_landings= round(nominal_mass/sum(nominal_mass)*100, digits= 2))%>%
  mutate(nominal_mass= round(nominal_mass))


topspp <- species %>%
  filter(Percent_of_total <= 98)%>%
  select(species_code)
```


Cluster analysis of vessels 

```{r echo=FALSE, message=FALSE, warning=FALSE}

#determine if the vessel is a hake or sole directed vessel
target_code <- drags %>%
  count(vessel_number, target_species_code)%>%
  normalise(n, vessel_number, "vessel_number")%>%
  filter(!norm<0.5)%>%
  mutate(target_code = if_else(norm>0.5 & 
                                 target_species_code == "HAKE", 
                               "Hake",
                               if_else(norm>0.5 & 
                                         target_species_code == "ECSOLE", 
                                       "Sole", "both"), "both"))



####
#cluster
####

#sum the catch by vessel, and normalise and square root the catch comp per vessel
test <- landings_catches%>%
  right_join(topspp)%>%
  group_by(vessel_number,species_code)%>%
  summarise(nominal_mass = sum(nominal_mass, na.rm = T))%>%
  normalise(nominal_mass, vessel_number, "vessel_number")%>%
  mutate(norm = sqrt(norm))%>%
  ungroup()%>%
  select(vessel_number, norm, species_code)%>%
  pivot_wider(names_from = species_code, values_from = norm)%>%
  mutate_all(~replace_na(.,0))%>%
  ungroup()%>% 
  column_to_rownames(var = "vessel_number")

#write.csv(test, "simp.ves.csv", row.names = F)

#distance matrix
dm <- vegdist(test, method="bray", na.rm = T)

#cluster
cluster<- dm %>%
  hclust(method = "average")

#plot the cluster analysis in a dendrogram (try get the numbers the right way)
x <- cluster%>%
  as.dendrogram()%>% 
  dendextend::set("labels_cex", 0.8)%>%
  dendextend::set("branches_lwd", 2)%>%
  colour_branches(h = 0.25, groupLabels = T,
                  col = brewer.pal(2,"Paired"))

plot(x)
title(ylab = 'Dissimilarity', line = 2.5)
title(xlab = 'Vessels', line = 2)

```

Run an MDS

```{r}
#get the cluster groups into the catch comp dataframe
dend_list <- get_subdendrograms(x, 2)
labels <- lapply(dend_list, labels)
grp<- labels %>%
  plyr::ldply( rbind)%>%
  t()%>%
  as_tibble()%>%
  pivot_longer(cols= 1:2,names_to = "grp", values_drop_na = T )%>%
  column_to_rownames(var = "value")

ves.s <- test %>% 
  rownames_to_column(var = "value")
  left_join(grp) %>% 
  left_join(select(target_code, vessel_number, target_code), by = ("row.names" = "vessel_number"))

  merge(test, grp, by = "row.names")

#write.csv(ves.s, "simp.ves.csv", , row.names = F)

#### MDS

#distance matrix

dm <- vegdist(ves.s[2:15], method="bray", na.rm = T)

#Do MDS
mds <- metaMDS(dm, 
               k=3,
               try=15, trymax=20,
               autotransform = FALSE)         #if it doesn't converge increase k by 1. 


MDS_xy <- data.frame(mds$points)


ggplot(MDS_xy, aes(MDS1, MDS2, colour = ves.s$grp, shape = ves.s$target_code)) +
  geom_point(size = 5) + 
  theme(legend.title = element_text(size = 14, face = "bold"), 
        legend.text = element_text(size = 12, face = "bold"), 
        legend.position = "right", 
        axis.text.x = element_text(face = "bold",colour = "black", size = 12), 
        axis.text.y = element_text(face = "bold", size = 12, colour = "black"), 
        axis.title.y = element_text(face = "bold", size = 14, colour = "black"),
        axis.title.x = element_text(face = "bold", size = 14, colour = "black"),
        panel.background = element_blank(), 
        panel.border = element_rect(fill = NA, colour = "black"), 
        legend.key=element_blank()) + 
  labs(x = "MDS 1", y = "MDS 2", colour = "Cluster", shape = "Target Species") +
  scale_colour_brewer(palette = "Paired", aesthetics = "colour")


```
Make a bar graph per cluster

```{r}
#bar graph
grp <- grp %>%
  rownames_to_column(var = "vessel_number")

spp <- topspp %>%
  rownames_to_column(var = "id")%>%
  mutate(id = as.numeric(id))

test <- landings_catches%>%
  mutate(vessel_number = as.character(vessel_number)) %>% 
  right_join(spp)%>%
  left_join(grp)
%>%
  group_by(grp, id, species_code)
%>%
  summarise(nominal_mass = sum(nominal_mass, na.rm = T))
%>%
  normalise(nominal_mass, grp, "grp")%>%
  mutate(norm = sqrt(norm))
%>%
  ggplot(aes(reorder(species_code, id), norm, fill = grp))+
  geom_col()+
  facet_wrap(~grp)+
  theme(legend.title = element_blank(), 
        legend.position = "none",
        axis.text.x = element_text(face = "bold",colour = "black", size = 8, 
                                   angle = 90, vjust = 0.5, hjust=1), 
        axis.text.y = element_text(face = "bold", size = 8, colour = "black"), 
        axis.title.y = element_text( face = "bold", size = 12, colour = "black"),
        axis.title.y.right = element_text( face = "bold", size = 12, colour = "blue"),
        axis.title.x = element_text(face = "bold", size = 12, colour = "black"),
        panel.background = element_blank(), 
        panel.border = element_rect(fill = NA, colour = "black"), 
        legend.key=element_blank()) +
  labs(x = "Species code", y = "Proportion")+
  scale_fill_brewer(palette = "Paired", aesthetics = "fill")


ggsave("chapter 3.4.jpeg")


```


cluster analysis of each variable year, month, area, vessel










